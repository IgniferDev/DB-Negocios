<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>DSS Dashboard — KPIs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
</head>
<body>
  <nav style="display:flex; gap:12px; align-items:center; margin-bottom:16px;">
    <a href="/" style="font-weight:700; font-size:18px;">DSS</a>
    <a href="/dashboard">Dashboard</a>
    <a href="/cube">Cubo OLAP</a>
    <a href="/bsc">Balanced Scorecard</a>
    <a href="/">Predict</a>
  </nav>

  <div class="header">
    <div>
      <div class="title">DSS — Dashboard de KPIs</div>
      <div class="subtitle">Visión rápida de rendimiento y riesgos — empresa de software</div>
    </div>
    <div class="small">Usuario: <strong>demo_user</strong> · Ambiente: <strong>local</strong></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="kpi">
        <div>
          <div class="label">Horas (Total)</div>
          <div class="value" id="kpi_hours">—</div>
        </div>
        <div style="text-align:right">
          <div class="label">Proyectos</div>
          <div class="value" id="kpi_projects">—</div>
        </div>
      </div>
      <div class="small" id="kpi_text_hours">Cargando...</div>
    </div>

    <div class="card">
      <div class="kpi">
        <div>
          <div class="label">Costo (USD)</div>
          <div class="value" id="kpi_cost">—</div>
        </div>
        <div style="text-align:right">
          <div class="label">Defectos (Total)</div>
          <div class="value" id="kpi_errors">—</div>
        </div>
      </div>
      <div class="small" id="kpi_text_cost">Cargando...</div>
    </div>

    <div class="card">
      <div class="kpi">
        <div>
          <div class="label">Utilización (promedio 30d)</div>
          <div class="value" id="kpi_util">—</div>
        </div>
        <div style="text-align:right">
          <div class="label">Burn Rate (prom)</div>
          <div class="value" id="kpi_burn">—</div>
        </div>
      </div>
      <div class="small" id="kpi_text_util">Cargando...</div>
    </div>
  </div>

  <div class="big">
    <div class="card">
      <div id="chart_hours" style="height:380px;"></div>
    </div>
    <div class="card">
      <div id="chart_burn" style="height:180px;"></div>
      <div id="chart_util" style="height:180px; margin-top:12px;"></div>
    </div>
  </div>

  <div class="table-wrap card">
    <h3 style="margin-top:0">Sección: Proyectos recientes</h3>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
      <div class="small">Tabla de proyectos (carga desde /api/cube/section)</div>
      <div>
        <button onclick="refreshTable()">Actualizar</button>
        <button onclick="exportTableCSV()">Exportar CSV</button>
      </div>
    </div>
    <table id="tbl_projects">
      <thead><tr><th>Project</th><th>Año</th><th>Horas</th><th>Costo</th><th>Revenue</th><th>Errors</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <p style="margin-top:12px;"><a href="/">Predict</a> | <a href="/cube">Cubo</a> | <a href="/bsc">Balanced Scorecard</a></p>

<script>
// Copiado/adaptado del dashboard anterior
async function fetchKPIs(){
  try {
    const res = await fetch('/api/kpis');
    const data = await res.json();

    const top = data.hours_cost_per_project.slice(0, 12);
    const projects = top.map(r => r[1]);
    const hours = top.map(r => Number(r[2] || 0));
    const costs = top.map(r => Number(r[3] || 0));
    const total_hours = data.hours_cost_per_project.reduce((s,r)=>s+(Number(r[2]||0)),0);
    const total_cost  = data.hours_cost_per_project.reduce((s,r)=>s+(Number(r[3]||0)),0);
    const projects_count = data.hours_cost_per_project.length;

    const util_rows = data.utilization_last_30_by_employee || [];
    const avg_util = util_rows.length ? (util_rows.reduce((s,r)=>s+Number(r[2]||0),0)/util_rows.length).toFixed(1): 0;

    const issues = data.issues_by_severity || [];
    const total_errors = issues.reduce((s,r)=>s+Number(r[2]||0),0);

    const burn = data.burn_rate || [];
    const avg_burn = burn.length ? (burn.reduce((s,r)=>s+(Number(r[2]||0)/( (new Date(r[4]) - new Date(r[3]))/86400000 || 1) ),0)/burn.length).toFixed(2) : "N/A";

    document.getElementById('kpi_hours').textContent = Intl.NumberFormat().format(Math.round(total_hours));
    document.getElementById('kpi_projects').textContent = projects_count;
    document.getElementById('kpi_cost').textContent = "$" + Intl.NumberFormat().format(Math.round(total_cost));
    document.getElementById('kpi_errors').textContent = total_errors;
    document.getElementById('kpi_util').textContent = avg_util + "h";
    document.getElementById('kpi_burn').textContent = avg_burn == "N/A" ? "N/A" : "$"+avg_burn;

    document.getElementById('kpi_text_hours').textContent = `Top proyectos por horas: ${projects.join(', ')}`;
    document.getElementById('kpi_text_cost').textContent = `Total coste: $${Intl.NumberFormat().format(Math.round(total_cost))}`;
    document.getElementById('kpi_text_util').textContent = `Promedio horas 30d: ${avg_util} por empleado`;

    var trace = { x: projects, y: hours, type: 'bar', marker:{color:'#2563eb'} };
    Plotly.react('chart_hours', [trace], { title: 'Horas por proyecto (Top)', margin:{t:40,l:40} }, {displayModeBar:false});

    var burn_x = burn.slice(0,6).map(r=>r[1]);
    var burn_y = burn.slice(0,6).map(r=> Number(r[2]||0) / Math.max(1,(new Date(r[4]) - new Date(r[3]))/86400000) );
    Plotly.react('chart_burn', [{x:burn_x,y:burn_y,type:'bar'}], {title:'Burn rate (últimos proyectos)', margin:{t:30}} , {displayModeBar:false});

    var topEmp = util_rows.slice(0,6).map(r=>r[1]);
    var topEmpVal = util_rows.slice(0,6).map(r=>Number(r[2]||0));
    Plotly.react('chart_util', [{labels:topEmp, values:topEmpVal, type:'pie', hole:0.6}], {title:'Top horas 30d'}, {displayModeBar:false});

    // load section table
    await refreshTable();
  } catch(err){
    console.error(err);
  }
}

async function refreshTable(){
  const year = new Date().getFullYear();
  const sec = await fetch(`/api/cube/section?year=${year}`);
  const secj = await sec.json();
  const tbody = document.querySelector('#tbl_projects tbody'); tbody.innerHTML = '';
  secj.slice(0,20).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.project_name}</td><td>${r.year||''}</td><td>${Math.round(r.total_hours)}</td><td>$${Math.round(r.total_cost)}</td><td>$${Math.round(r.total_revenue)}</td><td>${r.total_errors}</td>`;
    tbody.appendChild(tr);
  });
}

// Export table to CSV
function exportTableCSV(){
  const rows = Array.from(document.querySelectorAll('#tbl_projects tr'));
  const csv = rows.map(r=> Array.from(r.querySelectorAll('th,td')).map(cell => `"${(cell.textContent||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `projects_section_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

window.onload = fetchKPIs;
</script>
</body>
</html>
